<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œì´ ë…¸ë˜ ëª©ë¡</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        /* [1] íŒŒìŠ¤í…”í†¤ í…Œë§ˆ ì„¤ì • */
        :root { 
            --bg: #f0f4f8; --card: #ffffff; --text: #2d3748; --sub: #718096; --line: #e2e8f0;
            --input-bg: #ffffff; --primary: #667eea; --primary-text: #ffffff; --accent: #a3b1ff;
        }
        [data-theme="dark"] {
            --bg: #1a202c; --card: #2d3748; --text: #f7fafc; --sub: #a0aec0; --line: #4a5568; 
            --input-bg: #2d3748; --primary: #7f9cf5; --primary-text: #ffffff; --accent: #5a67d8;
        }
        [data-theme="pink"] {
            --bg: #fff5f7; --card: #ffffff; --text: #b83280; --sub: #d6bcfa; --line: #fed7e2;
            --input-bg: #ffffff; --primary: #f687b3; --primary-text: #ffffff; --accent: #fbb6ce;
        }

        /* [2] ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ */
        * { box-sizing: border-box; font-family: "Pretendard", sans-serif; transition: background 0.3s, border 0.3s, color 0.3s; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        header { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid var(--line); padding-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .title-area h1 { margin: 0; font-size: 28px; font-weight: 800; color: var(--primary); }
        .controls { display: flex; gap: 10px; align-items: center; }

        .sns-link { 
            display: flex; align-items: center; justify-content: center; 
            width: 42px; height: 42px; border-radius: 12px; 
            text-decoration: none; font-weight: 900; font-size: 10px; color: #fff; 
            transition: 0.2s; border: none; cursor: pointer;
        }
        .soop-btn { background-color: #4299e1; }
        .cafe-btn { background-color: #48bb78; }
        .sns-link:hover { transform: scale(1.05); filter: brightness(1.1); }

        .icon-btn { 
            width: 42px; height: 42px; background: var(--card); color: var(--text); 
            border: 1px solid var(--line); border-radius: 12px; cursor: pointer; 
            font-size: 18px; display: flex; align-items: center; justify-content: center; 
        }
        .icon-btn:hover { background: var(--line); }

        .admin-toggle-btn { 
            background: var(--primary); color: var(--primary-text); border: none; 
            padding: 0 16px; height: 42px; border-radius: 12px; cursor: pointer; 
            font-weight: 700; font-size: 14px; transition: 0.2s;
        }
        .admin-toggle-btn.active { background: #f56565 !important; color: #fff !important; }
        .add-btn { background: #4299e1; color: #fff; border: none; padding: 0 16px; height: 42px; border-radius: 12px; display: none; font-weight: 700; cursor: pointer; }

        .search-box { width: 100%; }
        .search-input { width: 100%; padding: 15px 20px; background: var(--input-bg); border: 2px solid var(--line); border-radius: 15px; color: var(--text); font-size: 16px; outline: none; }
        .search-input:focus { border-color: var(--primary); }

        /* [3] ê´€ë¦¬ì ì…ë ¥ íŒì—… (ëª¨ë‹¬) */
        .admin-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .admin-modal { background: var(--card); padding: 35px; border-radius: 30px; width: 100%; max-width: 680px; border: 1px solid var(--line); position: relative; max-height: 95vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        
        .helper-box { background: var(--bg); padding: 20px; border-radius: 20px; margin-bottom: 25px; border: 2px dashed var(--accent); }
        .helper-box p { margin: 0 0 12px 0; font-size: 14px; font-weight: 800; }
        .helper-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .helper-input { flex: 1; min-width: 200px; padding: 12px; border-radius: 12px; border: 1px solid var(--line); font-size: 15px; background: var(--card); color: var(--text); }
        .helper-btn { padding: 0 15px; height: 45px; border-radius: 12px; cursor: pointer; font-size: 12px; font-weight: 700; border: none; color: white; }
        .btn-bugs { background: #ff3c00; }
        .btn-yt { background: #ff0000; }
        .btn-form { background: #a0aec0; }
        
        .admin-modal textarea { width: 100%; padding: 20px; background: var(--bg); border: 1px solid var(--line); color: var(--text); border-radius: 15px; margin-bottom: 20px; font-size: 16px; line-height: 1.6; resize: vertical; min-height: 350px; }
        .status-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .status-btn { flex: 1; padding: 12px; background: var(--bg); border: 1px solid var(--line); color: var(--sub); border-radius: 12px; cursor: pointer; font-weight: 700; }
        .status-btn.active { background: var(--primary); color: var(--primary-text); }

        /* [4] ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (5ì—´ ìë™ ë°°ì¹˜) */
        .main-layout { display: flex; gap: 30px; align-items: flex-start; }
        aside { width: 220px; flex-shrink: 0; position: sticky; top: 20px; }
        .side-card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--line); margin-bottom: 15px; text-align: center; }
        
        .song-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .song-card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--line); position: relative; cursor: pointer; height: 100%; transition: transform 0.2s; }
        .song-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px rgba(0,0,0,0.1); }
        
        .edit-btn-group { display: none; position: absolute; top: 12px; right: 12px; gap: 6px; z-index: 10; }
        body.admin-mode .edit-btn-group { display: flex; }
        .edit-label { background: rgba(255,255,255,0.95); color: #2d3748; padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; }

        .art-box { width: 100%; aspect-ratio: 1/1; background: var(--line); overflow: hidden; }
        .art-box img { width: 100%; height: 100%; object-fit: cover; }
        .info { padding: 18px; }
        .title-row { font-size: 15px; font-weight: 700; margin-bottom: 8px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .card-artist { color: var(--sub); font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; }
        
        .card-badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 800; background: var(--bg); color: var(--sub); white-space: nowrap; border: 1px solid var(--line); margin-left: 4px; }
        .bg-status { background: #c6f6d5 !important; color: #22543d !important; border: none; }

        /* í•„í„° ì„¹ì…˜ */
        aside h3 { font-size: 12px; color: var(--sub); margin: 30px 0 12px 0; border-bottom: 2px solid var(--line); padding-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
        .filter-list { max-height: 300px; overflow-y: auto; font-size: 14px; }
        .filter-item { padding: 8px 0; cursor: pointer; color: var(--sub); }
        .filter-item:hover, .filter-item.active { color: var(--primary); font-weight: 800; }

        /* [5] ë…¸ë˜ ìƒì„¸ ëª¨ë‹¬ ë° 3ë‹¨ ë²„íŠ¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); width: 100%; max-width: 1050px; border-radius: 35px; padding: 40px; display: grid; grid-template-columns: 320px 1fr; gap: 40px; position: relative; height: 85vh; overflow: hidden; }
        .lyrics-area { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; }
        .lyrics-display { background: var(--bg); padding: 30px; border-radius: 20px; border: 1px solid var(--line); flex: 1; overflow-y: auto; white-space: pre-wrap; line-height: 2.3; font-size: 19px; color: var(--text); font-weight: 500; }
        
        .modal-btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 15px; flex-shrink: 0; }
        .link-btn { display: flex; align-items: center; justify-content: center; padding: 15px; text-align: center; border-radius: 15px; text-decoration: none; font-weight: 800; font-size: 14px; color: #fff; transition: 0.2s; }
        .close-btn { position: absolute; top: 25px; right: 30px; background: none; border: none; color: var(--sub); font-size: 35px; cursor: pointer; }

        .p1 { color: var(--text); } .p2 { color: #f56565; } .p3 { color: #4299e1; } .p4 { color: #48bb78; }

        footer { text-align: center; padding: 60px 20px; color: var(--sub); font-size: 13px; border-top: 2px solid var(--line); margin-top: 50px; line-height: 2; }
        #loading { text-align: center; padding: 40px; color: var(--sub); display: none; font-weight: 700; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="header-top">
            <div class="title-area"><h1 id="siteTitle">ì œì´ ë…¸ë˜ ëª©ë¡</h1></div>
            <div class="controls">
                <a href="https://www.sooplive.co.kr/station/qw794" target="_blank" class="sns-link soop-btn">SOOP</a>
                <a href="https://cafe.naver.com/jeykoreanfood" target="_blank" class="sns-link cafe-btn">CAFE</a>
                <button class="icon-btn" onclick="cycleTheme()" id="themeCycleBtn" title="í…Œë§ˆ ë³€ê²½">â˜€ï¸</button>
                <button class="admin-toggle-btn" onclick="toggleAdminMode()" id="adminToggle">ê´€ë¦¬ ëª¨ë“œ</button>
                <button class="add-btn" onclick="openAdmin()" id="addBtn">+ ì¶”ê°€</button>
            </div>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="ì œëª©, ê°€ìˆ˜, ë˜ëŠ” ì¥ë¥´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”..." oninput="handleSearch()">
        </div>
    </header>

    <div id="adminOverlay" class="admin-overlay" onclick="closeAdmin()">
        <div class="admin-modal" onclick="event.stopPropagation()">
            <h2 id="adminTitle" style="margin-top:0;">ë…¸ë˜ ì •ë³´ ê´€ë¦¬</h2>
            
            <div class="helper-box">
                <p>ğŸ” ì •ë³´ ì°¾ê¸° ë„ìš°ë¯¸ (ë²„íŠ¼ì„ ê°ê° í´ë¦­í•˜ì„¸ìš”)</p>
                <div class="helper-row">
                    <input type="text" id="helperInput" class="helper-input" placeholder="ê³¡ ì œëª© - ê°€ìˆ˜ ì…ë ¥">
                    <button type="button" class="helper-btn btn-bugs" onclick="searchBugs()">ë²…ìŠ¤ ê²€ìƒ‰</button>
                    <button type="button" class="helper-btn btn-yt" onclick="searchYT()">ìœ íŠœë¸Œ ê²€ìƒ‰</button>
                    <button type="button" class="helper-btn btn-form" onclick="fillTemplate()">ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
            </div>

            <div class="status-selector">
                <button type="button" class="status-btn active" onclick="setStatus('ì™„ê³¡', this)">ì™„ê³¡</button>
                <button type="button" class="status-btn" onclick="setStatus('1ì ˆ', this)">1ì ˆ</button>
                <button type="button" class="status-btn" onclick="setStatus('ê¸°íƒ€', this)">ê¸°íƒ€</button>
                <input type="hidden" id="f_status" value="ì™„ê³¡">
            </div>
            
            <textarea id="f_bulk_input" rows="12" placeholder="ì œëª©:&#10;ê°€ìˆ˜:&#10;ì¥ë¥´:&#10;í‚¤:&#10;ì´ë¯¸ì§€:&#10;ìœ íŠœë¸Œ ë§í¬:&#10;ê°€ì‚¬ì›ë¬¸ ë§í¬:&#10;ìŒì›+ê°€ì‚¬ ë§í¬:&#10;ê°€ì‚¬:"></textarea>
            
            <div style="display:flex; gap:10px;">
                <input type="hidden" id="edit_id">
                <button onclick="submitData()" class="admin-toggle-btn" style="flex:2; padding:15px; font-size:16px;">ë°ì´í„° ì €ì¥í•˜ê¸°</button>
                <button onclick="closeAdmin()" class="btn" style="flex:1; background:var(--line); color:var(--sub); border:none; border-radius:12px; cursor:pointer;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <aside>
            <div class="side-card">
                <div style="font-size: 11px; color: var(--sub); margin-bottom: 5px; font-weight: 800;">TOTAL SONGS</div>
                <div style="font-size: 28px; font-weight: 900;"><span id="totalCount">0</span>ê³¡</div>
            </div>
            <button onclick="resetFilters()" style="width:100%; padding:14px; background:var(--line); color:var(--sub); border:none; border-radius:15px; cursor:pointer; font-weight:800; margin-bottom:15px;">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button>
            <h3>ì •ë ¬</h3>
            <select id="sortSelect" onchange="handleSearch()" style="width: 100%; background: var(--card); color: var(--text); border: 2px solid var(--line); padding: 12px; border-radius: 12px; outline:none; font-weight:600;">
                <option value="latest">ìµœì‹ ìˆœ</option>
                <option value="titleAsc">ì œëª©ìˆœ</option>
                <option value="artistAsc">ê°€ìˆ˜ìˆœ</option>
            </select>
            <h3>ì¥ë¥´</h3><div id="categoryFilters" class="filter-list"></div>
            <h3>ê°€ìˆ˜ë³„</h3><div id="artistFilters" class="filter-list"></div>
        </aside>

        <div style="flex-grow: 1;">
            <div class="song-grid" id="mainGrid"></div>
            <div id="loading">ë…¸ë˜ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
        </div>
    </div>

    <footer>
        <p>Â© 2026 JEY SONGBOOK. All rights reserved.</p>
        <p>ë³¸ ì‚¬ì´íŠ¸ëŠ” ë¹„ì˜ë¦¬ì  í•™ìŠµ ëª©ì ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì‘ê¶Œ ê´€ë ¨ ë¬¸ì˜ëŠ” <b>base77data@gmail.com</b>ìœ¼ë¡œ ì—°ë½ ì£¼ì‹œë©´ ì¦‰ì‹œ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.</p>
    </footer>
</div>

<div id="modal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closeModal()">Ã—</button>
        <div id="modalSide"></div>
        <div class="lyrics-area">
            <div style="display:flex; align-items:center; gap:12px; background:var(--bg); padding:12px 20px; border-radius:15px; border:1px solid var(--line); flex-shrink:0;">
                <input type="number" id="lineCount" value="2" min="1" oninput="updateLyrics()" style="width:55px; padding:5px; text-align:center; border-radius:8px; border:1px solid var(--line); background:var(--card); color:var(--text); font-weight:700;"> <span>ì¤„ì”©</span>
                <div style="display:flex; gap:8px; margin-left:15px;">
                    <button class="p-btn active" onclick="setPerson(1, this)">1ì¸</button>
                    <button class="p-btn" onclick="setPerson(2, this)">2ì¸</button>
                    <button class="p-btn" onclick="setPerson(3, this)">3ì¸</button>
                    <button class="p-btn" onclick="setPerson(4, this)">4ì¸</button>
                </div>
            </div>
            <div id="lyricsDisplay" class="lyrics-display"></div>
            <div id="modalBtnArea" class="modal-btn-group"></div>
        </div>
    </div>
</div>

<script>
    // [1] Firebase ë° ì´ˆê¸°í™”
    const ADMIN_PW = "1234";
    const firebaseConfig = { apiKey: "AIzaSyAWAe1oGCH3-bT97fZyB8qW_hFE5aOT9BE", authDomain: "jey-songbook-1369e.firebaseapp.com", projectId: "jey-songbook-1369e", storageBucket: "jey-songbook-1369e.firebasestorage.app", messagingSenderId: "541154865578", appId: "1:541154865578:web:1a71c78e9d0b7eefa7bbd3" };
    firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

    let allSongs = [], songDataList = {}, selectedCategory = 'ì „ì²´', selectedArtist = 'ì „ì²´', isAdmin = false;
    let currentLyrics = "", currentPersonCount = 1, displayLimit = 15, filteredSongs = [];
    let themeState = 0; // 0: Light, 1: Dark, 2: Pink

    // [2] ê²€ìƒ‰ ë„ìš°ë¯¸ ê¸°ëŠ¥
    function searchBugs() {
        const q = document.getElementById('helperInput').value;
        if(!q) return alert("ì…ë ¥í•´ì£¼ì„¸ìš”!");
        window.open(`https://music.bugs.co.kr/search/track?q=${encodeURIComponent(q)}`, '_blank');
    }
    function searchYT() {
        const q = document.getElementById('helperInput').value;
        if(!q) return alert("ì…ë ¥í•´ì£¼ì„¸ìš”!");
        window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`, '_blank');
    }
    function fillTemplate() {
        document.getElementById('f_bulk_input').value = "ì œëª©: \nê°€ìˆ˜: \nì¥ë¥´: \ní‚¤: \nì´ë¯¸ì§€: \nìœ íŠœë¸Œ ë§í¬: \nê°€ì‚¬ì›ë¬¸ ë§í¬: \nìŒì›+ê°€ì‚¬ ë§í¬: \nê°€ì‚¬: ";
    }

    // [3] í…Œë§ˆ ë° ë””ìì¸ ì„¤ì •
    const genreColors = { 'í™í•©': { bg: '#fed7d7', text: '#9b2c2c' }, 'R&B': { bg: '#e9d8fd', text: '#553c9a' }, 'ëŒ„ìŠ¤': { bg: '#bee3f8', text: '#2c5282' }, 'ë°œë¼ë“œ': { bg: '#c6f6d5', text: '#22543d' }, 'POP': { bg: '#fed7e2', text: '#97266d' } };
    function getGenreStyle(g) { const c = genreColors[g] || { bg: '#edf2f7', text: '#4a5568' }; return `background: ${c.bg}; color: ${c.text};`; }

    function cycleTheme() {
        themeState = (themeState + 1) % 3;
        const html = document.documentElement;
        const title = document.getElementById('siteTitle');
        const btn = document.getElementById('themeCycleBtn');
        if (themeState === 0) { html.removeAttribute('data-theme'); title.innerText = "ì œì´ ë…¸ë˜ ëª©ë¡"; btn.innerText = "â˜€ï¸"; }
        else if (themeState === 1) { html.setAttribute('data-theme', 'dark'); title.innerText = "ì œì´ ë…¸ë˜ ëª©ë¡"; btn.innerText = "ğŸŒ™"; }
        else if (themeState === 2) { html.setAttribute('data-theme', 'pink'); title.innerText = "ê³¤ë“€ ë…¸ë˜ ëª©ë¡"; btn.innerText = "ğŸ’–"; }
    }

    // [4] ê´€ë¦¬ì ëª¨ë“œ ì œì–´
    function toggleAdminMode() {
        if (!isAdmin) {
            if (prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:") === ADMIN_PW) {
                isAdmin = true; document.body.classList.add('admin-mode');
                document.getElementById('adminToggle').classList.add('active');
                document.getElementById('addBtn').style.display = "block";
                renderGrid();
            } else alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
        } else {
            isAdmin = false; document.body.classList.remove('admin-mode');
            document.getElementById('adminToggle').classList.remove('active');
            document.getElementById('addBtn').style.display = "none";
            renderGrid();
        }
    }

    // [5] ë°ì´í„° í†µì‹  ë° í•„í„°
    db.collection("songs").orderBy("createdAt", "desc").onSnapshot(snap => {
        allSongs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        allSongs.forEach(s => songDataList[s.id] = s);
        document.getElementById('totalCount').innerText = allSongs.length;
        updateFilterUI(); handleSearch();
    });

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const sort = document.getElementById('sortSelect').value;
        filteredSongs = allSongs.filter(s => {
            const matchSearch = (s.title + s.artist + (s.genre||'')).toLowerCase().includes(term);
            const matchCat = selectedCategory === 'ì „ì²´' || (s.genre) === selectedCategory;
            const matchArt = selectedArtist === 'ì „ì²´' || s.artist === selectedArtist;
            return matchSearch && matchCat && matchArt;
        });
        if (sort === 'titleAsc') filteredSongs.sort((a,b) => a.title.localeCompare(b.title, 'ko'));
        else if (sort === 'artistAsc') filteredSongs.sort((a,b) => a.artist.localeCompare(b.artist, 'ko'));
        displayLimit = 15; renderGrid();
    }

    function renderGrid() {
        const grid = document.getElementById('mainGrid');
        const songsToRender = filteredSongs.slice(0, displayLimit);
        grid.innerHTML = songsToRender.map(s => `
            <div class="song-card" onclick="openPop('${s.id}')">
                <div class="edit-btn-group">
                    <div class="edit-label" onclick="event.stopPropagation(); openAdmin('${s.id}')">ìˆ˜ì •</div>
                    <div class="edit-label" style="background:#feb2b2; color:#9b2c2c;" onclick="event.stopPropagation(); deleteSong('${s.id}')">ì‚­ì œ</div>
                </div>
                <div class="art-box"><img src="${s.imgUrl || 'https://via.placeholder.com/200'}" loading="lazy"></div>
                <div class="info">
                    <span class="title-row">${s.title}</span>
                    <div class="sub-row">
                        <span class="card-artist">${s.artist}</span>
                        <div style="display:flex; align-items:center;">
                            <span class="card-badge" style="${getGenreStyle(s.genre)}">${s.genre || 'ê¸°íƒ€'}</span>
                            <span class="card-badge ${s.status === 'ì™„ê³¡' ? 'bg-status' : ''}">${s.status || 'ì™„ê³¡'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('loading').style.display = (displayLimit >= filteredSongs.length) ? 'none' : 'block';
    }

    window.onscroll = function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            if (displayLimit < filteredSongs.length) { displayLimit += 15; renderGrid(); }
        }
    };

    function updateFilterUI() {
        const genres = ['ì „ì²´', ...new Set(allSongs.map(s => s.genre).filter(Boolean))];
        document.getElementById('categoryFilters').innerHTML = genres.map(g => `<div class="filter-item ${selectedCategory===g?'active':''}" onclick="selectedCategory='${g}'; handleSearch(); updateFilterUI();">${g}</div>`).join('');
        const artsRaw = [...new Set(allSongs.map(s => s.artist))].sort((a,b) => a.localeCompare(b, 'ko'));
        const artists = ['ì „ì²´', ...artsRaw];
        document.getElementById('artistFilters').innerHTML = artists.map(a => `<div class="filter-item ${selectedArtist===a?'active':''}" onclick="selectedArtist='${a}'; handleSearch(); updateFilterUI();">${a}</div>`).join('');
    }

    // [6] ìƒì„¸ í˜ì´ì§€ ë¡œì§ (3ë‹¨ ë²„íŠ¼)
    function openPop(id) {
        const s = songDataList[id]; if(!s) return;
        currentLyrics = s.lyrics || "";
        document.getElementById('modalSide').innerHTML = `
            <div style="width:100%; aspect-ratio:1; border-radius:25px; overflow:hidden; margin-bottom:15px; border:2px solid var(--line);"><img src="${s.imgUrl}" style="width:100%; height:100%; object-fit:cover;"></div>
            <div style="font-size:26px; font-weight:900; margin-bottom:5px; color:var(--primary);">${s.title}</div>
            <div style="font-size:18px; color:var(--sub); margin-bottom:25px; font-weight:600;">${s.artist}</div>
            <div style="background:var(--bg); padding:18px; border-radius:20px; font-size:14px; line-height:1.8; border:1px solid var(--line);">
                <div><b>ì¥ë¥´:</b> <span class="card-badge" style="${getGenreStyle(s.genre)}">${s.genre || '-'}</span></div>
                <div style="margin-top:5px;"><b>ìƒíƒœ:</b> ${s.status || 'ì™„ê³¡'}</div>
                <div style="margin-top:5px;"><b>Key:</b> ${s.key || 'N/A'}</div>
            </div>
        `;
        document.getElementById('modalBtnArea').innerHTML = `
            ${s.clipUrl ? `<a href="${s.clipUrl}" target="_blank" class="link-btn" style="background:#63b3ed;">ìŒì› or ë®¤ë¹„</a>` : ''}
            ${s.audioLyricsUrl ? `<a href="${s.audioLyricsUrl}" target="_blank" class="link-btn" style="background:#9f7aea;">ìŒì›+ê°€ì‚¬</a>` : ''}
            ${s.lyricsLink ? `<a href="${s.lyricsLink}" target="_blank" class="link-btn" style="background:#68d391;">ê°€ì‚¬ ì›ë¬¸</a>` : ''}
        `;
        setPerson(1); document.getElementById('modal').style.display = 'flex';
        document.getElementById('lyricsDisplay').scrollTop = 0;
    }

    function updateLyrics() {
        const unit = parseInt(document.getElementById('lineCount').value) || 2;
        const lines = currentLyrics.split('\n').filter(l => l.trim() !== "");
        document.getElementById('lyricsDisplay').innerHTML = lines.map((line, idx) => `<div class="p${(Math.floor(idx / unit) % currentPersonCount) + 1}">${line}</div>`).join('');
    }

    function setPerson(num, btn = null) {
        currentPersonCount = num;
        if(btn) { document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        updateLyrics();
    }

    function setStatus(val, btn) {
        document.getElementById('f_status').value = val;
        document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
    }

    // [7] ê´€ë¦¬ì ë°ì´í„° ì²˜ë¦¬ (ìŒì›+ê°€ì‚¬ í•„ë“œ ì¶”ê°€)
    function openAdmin(id = null) {
        document.getElementById('adminOverlay').style.display = 'flex';
        if(id) {
            const s = songDataList[id]; document.getElementById('edit_id').value = id;
            document.getElementById('adminTitle').innerText = "ë…¸ë˜ ì •ë³´ ìˆ˜ì •";
            document.getElementById('f_bulk_input').value = `ì œëª©: ${s.title}\nê°€ìˆ˜: ${s.artist}\nì¥ë¥´: ${s.genre||''}\ní‚¤: ${s.key||''}\nì´ë¯¸ì§€: ${s.imgUrl}\nìœ íŠœë¸Œ ë§í¬: ${s.clipUrl||''}\nê°€ì‚¬ì›ë¬¸ ë§í¬: ${s.lyricsLink||''}\nìŒì›+ê°€ì‚¬ ë§í¬: ${s.audioLyricsUrl||''}\nê°€ì‚¬:\n${s.lyrics}`;
            document.getElementById('f_status').value = s.status || 'ì™„ê³¡';
            document.querySelectorAll('.status-btn').forEach(b => { if(b.innerText === (s.status||'ì™„ê³¡')) b.classList.add('active'); else b.classList.remove('active'); });
        } else {
            document.getElementById('edit_id').value = ""; document.getElementById('adminTitle').innerText = "ìƒˆ ë…¸ë˜ ì¶”ê°€";
            document.getElementById('f_bulk_input').value = ""; setStatus('ì™„ê³¡', document.querySelectorAll('.status-btn')[0]);
        }
    }

    function submitData() {
        const bulk = document.getElementById('f_bulk_input').value;
        const editId = document.getElementById('edit_id').value;
        const data = { lyrics: "", status: document.getElementById('f_status').value, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
        let isLyrics = false, lyArr = [];
        bulk.split('\n').forEach(l => {
            if(l.startsWith('ì œëª©:')) data.title = l.replace('ì œëª©:','').trim();
            else if(l.startsWith('ê°€ìˆ˜:')) data.artist = l.replace('ê°€ìˆ˜:','').trim();
            else if(l.startsWith('ì¥ë¥´:')) data.genre = l.replace('ì¥ë¥´:','').trim();
            else if(l.startsWith('í‚¤:')) data.key = l.replace('í‚¤:','').trim();
            else if(l.startsWith('ì´ë¯¸ì§€:')) data.imgUrl = l.replace('ì´ë¯¸ì§€:','').trim();
            else if(l.startsWith('ìœ íŠœë¸Œ ë§í¬:')) data.clipUrl = l.replace('ìœ íŠœë¸Œ ë§í¬:','').trim();
            else if(l.startsWith('ê°€ì‚¬ì›ë¬¸ ë§í¬:')) data.lyricsLink = l.replace('ê°€ì‚¬ì›ë¬¸ ë§í¬:','').trim();
            else if(l.startsWith('ìŒì›+ê°€ì‚¬ ë§í¬:')) data.audioLyricsUrl = l.replace('ìŒì›+ê°€ì‚¬ ë§í¬:','').trim();
            else if(l.startsWith('ê°€ì‚¬:')) isLyrics = true;
            else if(isLyrics) lyArr.push(l);
        });
        data.lyrics = lyArr.join('\n').trim();
        const ref = db.collection("songs");
        (editId ? ref.doc(editId).update(data) : ref.add(data)).then(() => { alert("ì €ì¥ì™„ë£Œ!"); closeAdmin(); });
    }

    async function deleteSong(id) { if(confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await db.collection("songs").doc(id).delete(); }
    function closeAdmin() { document.getElementById('adminOverlay').style.display = 'none'; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function resetFilters() { selectedCategory = 'ì „ì²´'; selectedArtist = 'ì „ì²´'; document.getElementById('searchInput').value = ""; handleSearch(); updateFilterUI(); }
</script>
</body>
</html>
