<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œì´ ë…¸ë˜ ëª©ë¡</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        /* í…Œë§ˆë³„ ë³€ìˆ˜ ì„¤ì • */
        :root { 
            --bg: #0a0a0a; --card: #141414; --text: #ffffff; --sub: #888888; --line: #222222; 
            --btn-bg: #ffffff; --btn-text: #000000;
        }
        [data-theme="light"] {
            --bg: #f5f5f7; --card: #ffffff; --text: #1d1d1f; --sub: #86868b; --line: #d2d2d7;
            --btn-bg: #1d1d1f; --btn-text: #ffffff;
        }

        * { box-sizing: border-box; font-family: "Pretendard", sans-serif; transition: background 0.3s, color 0.3s; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid var(--line); padding-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .controls { display: flex; gap: 10px; align-items: center; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .icon-btn { background: var(--card); border: 1px solid var(--line); color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 18px; }
        .admin-toggle-btn { background: var(--btn-bg); color: var(--btn-text); border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; }
        .admin-toggle-btn.active { background: #ff4d4d; color: #fff; }

        .search-box { width: 100%; position: relative; }
        .search-input { width: 100%; padding: 12px 20px; background: var(--card); border: 1px solid var(--line); border-radius: 8px; color: var(--text); font-size: 16px; outline: none; }
        
        .admin-section { background: var(--card); padding: 25px; border-radius: 12px; margin-bottom: 30px; display: none; border: 1px solid var(--line); }
        .admin-section textarea { width: 100%; padding: 15px; background: var(--bg); border: 1px solid var(--line); color: var(--text); border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        
        .status-selector { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .status-btn { padding: 10px 20px; background: var(--bg); border: 1px solid var(--line); color: var(--sub); border-radius: 6px; cursor: pointer; font-weight: 700; }
        .status-btn.active { background: var(--btn-bg); color: var(--btn-text); }

        .song-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .song-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid var(--line); position: relative; cursor: pointer; height: 100%; }
        
        /* ê´€ë¦¬ ëª¨ë“œìš© ìˆ˜ì •/ì‚­ì œ ë ˆì´ë¸” */
        .edit-btn-group { display: none; position: absolute; top: 10px; right: 10px; gap: 5px; z-index: 10; }
        body.admin-mode .edit-btn-group { display: flex; }
        .edit-label { background: rgba(255,255,255,0.9); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 800; }
        
        .art-box { width: 100%; aspect-ratio: 1/1; background: var(--line); overflow: hidden; }
        .art-box img { width: 100%; height: 100%; object-fit: cover; }
        .info { padding: 15px; }
        .title-row { font-size: 16px; font-weight: 700; margin-bottom: 8px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sub-row { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
        
        .badge-group { display: flex; gap: 4px; }
        .card-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; white-space: nowrap; }
        .bg-genre { background: var(--line); color: var(--text); }
        .bg-status { background: #00e676; color: #000; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); width: 100%; max-width: 1000px; border-radius: 20px; padding: 40px; display: grid; grid-template-columns: 320px 1fr; gap: 40px; position: relative; height: 80vh; overflow: hidden; }
        .lyrics-display { background: var(--bg); padding: 25px; border-radius: 12px; border: 1px solid var(--line); flex: 1; overflow-y: scroll !important; white-space: pre-wrap; line-height: 2; font-size: 18px; }
        
        aside h3 { font-size: 14px; color: var(--sub); margin: 20px 0 10px 0; border-bottom: 1px solid var(--line); padding-bottom: 5px; }
        .filter-item { cursor: pointer; line-height: 2; color: var(--sub); }
        .filter-item.active { color: var(--text); font-weight: 800; }

        footer { margin-top: 50px; padding: 40px 20px; border-top: 1px solid var(--line); text-align: center; color: var(--sub); font-size: 12px; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="header-top">
            <h1>ì œì´ ë…¸ë˜ ëª©ë¡</h1>
            <div class="controls">
                <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
                <button class="admin-toggle-btn" onclick="toggleAdminMode()" id="adminToggle">ê´€ë¦¬ ëª¨ë“œ ì¼œê¸°</button>
                <button class="admin-btn" onclick="openAdmin()" style="display:none;" id="addBtn">+ ê³¡ ì¶”ê°€</button>
            </div>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="ì œëª©, ê°€ìˆ˜, ë˜ëŠ” ì¥ë¥´ ê²€ìƒ‰..." oninput="handleSearch()">
        </div>
    </header>

    <div id="adminBox" class="admin-section">
        <div class="status-selector">
            <button type="button" class="status-btn active" onclick="setStatus('ì™„ê³¡', this)">ì™„ê³¡</button>
            <button type="button" class="status-btn" onclick="setStatus('1ì ˆ', this)">1ì ˆ</button>
            <button type="button" class="status-btn" onclick="setStatus('ê¸°íƒ€', this)">ê¸°íƒ€</button>
            <input type="hidden" id="f_status" value="ì™„ê³¡">
        </div>
        <textarea id="f_bulk_input" rows="10" placeholder="ì œëª©:&#10;ê°€ìˆ˜:&#10;ì¥ë¥´:&#10;í‚¤:&#10;ì´ë¯¸ì§€:&#10;ìœ íŠœë¸Œ ë§í¬:&#10;ê°€ì‚¬ë§í¬:&#10;ê°€ì‚¬:"></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="submitData()" class="admin-toggle-btn" style="flex:2; padding:15px;">ì €ì¥í•˜ê¸°</button>
            <button onclick="closeAdmin()" class="admin-toggle-btn" style="flex:1; background:#333; color:#fff;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div style="display: flex; gap: 30px; align-items: flex-start;">
        <aside style="width: 200px; flex-shrink: 0; position: sticky; top: 20px;">
            <div style="text-align: center; background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--line); margin-bottom: 15px;">
                <span id="totalCount" style="font-size: 24px; font-weight: 800;">0</span> ê³¡
            </div>
            <button onclick="resetFilters()" style="width:100%; padding:10px; background:var(--line); color:var(--text); border:none; border-radius:8px; cursor:pointer; font-weight:700;">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button>
            <h3>ì •ë ¬</h3>
            <select id="sortSelect" onchange="handleSearch()" style="width: 100%; background: var(--card); color: var(--text); border: 1px solid var(--line); padding: 8px; border-radius: 8px;">
                <option value="latest">ìµœì‹ ìˆœ</option>
                <option value="titleAsc">ì œëª©ìˆœ</option>
                <option value="artistAsc">ê°€ìˆ˜ìˆœ</option>
            </select>
            <h3>ì¥ë¥´</h3><div id="categoryFilters"></div>
            <h3>ê°€ìˆ˜ë³„</h3><div id="artistFilters" style="max-height:300px; overflow-y:auto;"></div>
        </aside>

        <div style="flex-grow: 1;">
            <div class="song-grid" id="mainGrid"></div>
            <div id="loading" style="text-align:center; padding:20px; color:var(--sub);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>
    <footer>
        <p>Â© 2026 JEY SONGBOOK. ë¹„ì˜ë¦¬ í•™ìŠµ ëª©ì  ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.</p>
    </footer>
</div>

<div id="modal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="btn-close-abs" onclick="closeModal()">Ã—</button>
        <div id="modalSide" class="modal-side"></div>
        <div class="lyrics-area">
            <div class="split-controls">
                <input type="number" id="lineCount" class="input-num" value="2" min="1" oninput="updateLyrics()"> <span>ì¤„ì”©</span>
                <div style="display:flex; gap:5px; margin-left:10px;">
                    <button class="p-btn active" onclick="setPerson(1, this)">1ì¸</button>
                    <button class="p-btn" onclick="setPerson(2, this)">2ì¸</button>
                </div>
            </div>
            <div id="lyricsDisplay" class="lyrics-display"></div>
            <div id="linkArea" class="link-group"></div>
        </div>
    </div>
</div>

<script>
    const ADMIN_PW = "1234";
    const firebaseConfig = { apiKey: "AIzaSyAWAe1oGCH3-bT97fZyB8qW_hFE5aOT9BE", authDomain: "jey-songbook-1369e.firebaseapp.com", projectId: "jey-songbook-1369e", storageBucket: "jey-songbook-1369e.firebasestorage.app", messagingSenderId: "541154865578", appId: "1:541154865578:web:1a71c78e9d0b7eefa7bbd3" };
    firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

    let allSongs = [], songDataList = {}, selectedCategory = 'ì „ì²´', selectedArtist = 'ì „ì²´', isAdmin = false;
    let displayLimit = 12, filteredSongs = [];

    // í…Œë§ˆ í† ê¸€
    function toggleTheme() {
        const theme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('themeBtn').innerText = theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // ê´€ë¦¬ ëª¨ë“œ í† ê¸€
    function toggleAdminMode() {
        if (!isAdmin) {
            const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (pw === ADMIN_PW) {
                isAdmin = true;
                document.body.classList.add('admin-mode');
                document.getElementById('adminToggle').innerText = "ê´€ë¦¬ ëª¨ë“œ ë„ê¸°";
                document.getElementById('adminToggle').classList.add('active');
                document.getElementById('addBtn').style.display = "block";
            } else if (pw !== null) alert("í‹€ë ¸ìŠµë‹ˆë‹¤.");
        } else {
            isAdmin = false;
            document.body.classList.remove('admin-mode');
            document.getElementById('adminToggle').innerText = "ê´€ë¦¬ ëª¨ë“œ ì¼œê¸°";
            document.getElementById('adminToggle').classList.remove('active');
            document.getElementById('addBtn').style.display = "none";
            closeAdmin();
        }
    }

    // ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ (ê¸°ì¡´ ë¡œì§ ìµœì í™”)
    db.collection("songs").orderBy("createdAt", "desc").onSnapshot(snap => {
        allSongs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        snap.forEach(doc => { songDataList[doc.id] = doc.data(); });
        document.getElementById('totalCount').innerText = allSongs.length;
        updateFilterUI(); handleSearch();
    });

    function handleSearch() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const sortType = document.getElementById('sortSelect').value;
        filteredSongs = allSongs.filter(s => {
            const matchSearch = (s.title + s.artist + (s.genre||'')).toLowerCase().includes(searchTerm);
            const matchCat = selectedCategory === 'ì „ì²´' || (s.genre||s.category) === selectedCategory;
            const matchArt = selectedArtist === 'ì „ì²´' || s.artist === selectedArtist;
            return matchSearch && matchCat && matchArt;
        });
        if (sortType === 'titleAsc') filteredSongs.sort((a,b) => a.title.localeCompare(b.title, 'ko'));
        else if (sortType === 'artistAsc') filteredSongs.sort((a,b) => a.artist.localeCompare(b.artist, 'ko'));
        displayLimit = 12; renderGrid();
    }

    function renderGrid() {
        const grid = document.getElementById('mainGrid');
        const songs = filteredSongs.slice(0, displayLimit);
        grid.innerHTML = songs.map(s => `
            <div class="song-card" onclick="openPop('${s.id}')">
                <div class="edit-btn-group">
                    <div class="edit-label" onclick="event.stopPropagation(); openAdmin('${s.id}')">ìˆ˜ì •</div>
                    <div class="edit-label" style="background:#ff4d4d; color:#fff;" onclick="event.stopPropagation(); deleteSong('${s.id}')">ì‚­ì œ</div>
                </div>
                <div class="art-box"><img src="${s.imgUrl}" loading="lazy"></div>
                <div class="info">
                    <span class="title-row">${s.title}</span>
                    <div class="sub-row">
                        <span class="card-artist">${s.artist}</span>
                        <div class="badge-group">
                            <span class="card-badge bg-genre">${s.genre || 'ê¸°íƒ€'}</span>
                            <span class="card-badge bg-status">${s.status || 'ì™„ê³¡'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('loading').style.display = (displayLimit >= filteredSongs.length) ? 'none' : 'block';
    }

    // ìŠ¤í¬ë¡¤ ë° ê¸°íƒ€ ê¸°ëŠ¥ (ê¸°ì¡´ ìœ ì§€)
    window.onscroll = () => { if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) { if (displayLimit < filteredSongs.length) { displayLimit += 12; renderGrid(); } } };
    function setStatus(v, b) { document.getElementById('f_status').value = v; document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); }
    function openAdmin(id = null) {
        document.getElementById('adminBox').style.display = 'block';
        if(id) {
            const s = songDataList[id]; document.getElementById('edit_id').value = id;
            document.getElementById('f_bulk_input').value = `ì œëª©: ${s.title}\nê°€ìˆ˜: ${s.artist}\nì¥ë¥´: ${s.genre||''}\ní‚¤: ${s.key||''}\nì´ë¯¸ì§€: ${s.imgUrl}\nìœ íŠœë¸Œ ë§í¬: ${s.clipUrl||''}\nê°€ì‚¬ë§í¬: ${s.lyricsLink||''}\nê°€ì‚¬:\n${s.lyrics}`;
        } else { document.getElementById('edit_id').value = ""; document.getElementById('f_bulk_input').value = ""; }
    }
    function closeAdmin() { document.getElementById('adminBox').style.display = 'none'; }
    function submitData() {
        const bulk = document.getElementById('f_bulk_input').value;
        const id = document.getElementById('edit_id').value;
        const data = { status: document.getElementById('f_status').value, lyrics: "" };
        bulk.split('\n').forEach(l => {
            if(l.startsWith('ì œëª©:')) data.title = l.split(':')[1].trim();
            if(l.startsWith('ê°€ìˆ˜:')) data.artist = l.split(':')[1].trim();
            if(l.startsWith('ì¥ë¥´:')) data.genre = l.split(':')[1].trim();
            if(l.startsWith('ì´ë¯¸ì§€:')) data.imgUrl = l.split(':')[1].trim();
        });
        const ref = db.collection("songs");
        (id ? ref.doc(id).update(data) : ref.add({...data, createdAt: firebase.firestore.FieldValue.serverTimestamp()})).then(() => { alert("ì™„ë£Œ"); closeAdmin(); });
    }
    async function deleteSong(id) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await db.collection("songs").doc(id).delete(); }
    function updateFilterUI() {
        const cats = ['ì „ì²´', ...new Set(allSongs.map(s => s.genre).filter(Boolean))];
        document.getElementById('categoryFilters').innerHTML = cats.map(c => `<div class="filter-item ${selectedCategory===c?'active':''}" onclick="selectedCategory='${c}'; handleSearch(); updateFilterUI();">${c}</div>`).join('');
        const arts = ['ì „ì²´', ...new Set(allSongs.map(s => s.artist))].sort();
        document.getElementById('artistFilters').innerHTML = arts.map(a => `<div class="filter-item ${selectedArtist===a?'active':''}" onclick="selectedArtist='${a}'; handleSearch(); updateFilterUI();">${a}</div>`).join('');
    }
    function resetFilters() { selectedCategory = 'ì „ì²´'; selectedArtist = 'ì „ì²´'; handleSearch(); updateFilterUI(); }
    function openPop(id) {
        const s = songDataList[id]; currentLyrics = s.lyrics;
        document.getElementById('modalSide').innerHTML = `<div class="m-art"><img src="${s.imgUrl}"></div><div class="m-title">${s.title}</div><div class="m-artist">${s.artist}</div>`;
        document.getElementById('linkArea').innerHTML = `<a href="${s.clipUrl}" target="_blank" class="link-btn">ìœ íŠœë¸Œ ë³´ê¸°</a>`;
        setPerson(1); document.getElementById('modal').style.display = 'flex';
    }
    function setPerson(n, b) { if(b) { document.querySelectorAll('.p-btn').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); } updateLyrics(n); }
    function updateLyrics(n = 1) { document.getElementById('lyricsDisplay').innerText = currentLyrics; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
</script>
</body>
</html>

